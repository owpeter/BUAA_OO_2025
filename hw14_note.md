# 题目描述

在一所小型图书馆中，用户借阅图书需要遵守一定的规章制度。我们需要你模拟一个小型的图书管理系统，完成图书馆所支持的相关业务。

图书馆里的所有图书按照 “类别号-序列号” 的形式编制ISBN号（同学们可以理解为 ISBN 国际标准书号的简化形式，即一本书的ISBN号是唯一的，它的所有副本的ISBN号都是相同的）。图书分 A 、B 、C 三类，由类别号标识，每种类别可能包含多个图书。每个ISBN号的图书可能具有多个副本（具有不同副本号）。图书馆中具体的某一本书籍由唯一的“类别号-序列号-副本号”形式编制书号。对于不同类别的书，有不同的借阅数量限制。

图书馆的运行分为两个时段：白天开馆，夜晚闭馆。开馆后，图书管理系统需要处理用户的各种请求，依据图书馆的运行规则决定是否批准用户的请求；同时，开馆时和闭馆时，图书馆内部依据需要整理各部门的图书，以满足接下来可能处理的各种请求。

在上次作业中，开馆时图书管理系统需要处理的请求包括：借书、还书、查询、预约和预约取书。

**本次作业新增的情况有：热门书架，阅读，归还。**

## 一、流程描述
重要概念说明：

- 本次作业中，我们规定：书籍仅可以存在于如下六个位置：普通书架、热门书架、预约处、借还处、阅览室和用户；普通书架和热门书架统称为书架，“书籍在架”是指存在该ISBN号的任一副本在书架
- 图书馆系统提供自助查询机查询书籍历史移动轨迹。
- 图书馆开馆后接收用户请求，输出处理结果；开馆和闭馆整理图书时，输出图书的转运路径。

**借阅流程**

若一位用户来到图书馆借阅某书籍，按照如下规则来进行处理：

1. 若欲借阅的书籍无余本在架，借阅失败；
2. 若欲借阅的书籍为 A 类书籍，借阅失败（ A 类图书无法借阅）；
3. 若欲借阅的书籍为 B 类或 C 类书籍，若符合借阅数量限制则借阅成功，该用户从此刻起持有该书；否则借阅失败，书籍仍留在书架。

**还书流程**

若一位用户来到图书馆归还某书籍，则该用户会前往借还处，在本次作业中还书立即成功，从此刻起，借还处持有该书，用户不再持有该书。

**预约流程**

若一位用户需要预约某书籍，则该用户需要前往预约处登记。

1. 该用户必须满足下述要求才可以预约成功：
   - 预约的书不是 A 类书（规定 A 类书无法预约）。
   - 若已经持有一本 B 类书，则无法再预约任何 B 类书。、
   - 若已经持有某ISBN号的 C 类书，则不能预约该ISBN号的 C 类书。
   - 若此前已经预定过书籍且还未取书，则预约失败。
2. 预约成功后，图书馆可在此后的整理流程中选择将书送至预约处，送至预约处的图书需要指定是为了满足哪个用户的预约请求而送达的，具体输出格式见后。
3. 图书送至预约处后，若在开馆后整理中送达，则从当日起为该用户保留 5 天；若在闭馆后整理中送达，从次日起为该用户保留 5 天。在此期间，该书不能在整理流程中移动。第五天闭馆时，该书不再视作为该用户保留，视为预约失效。从次日起，预约该书的用户将无法取走该书，图书馆可对该书进行整理。例如1月1日开馆后送达，则1月5日闭馆后，该书不再为用户保留；1月1日闭馆后送达，则1月6日闭馆后，该书不再为用户保留。

**取书流程**

用户只能去预约处取书。

若预约处存在一本为该用户预留的图书，且取书后该用户持有的书仍然满足借阅数量限制，则该用户取书成功，即刻起由用户持有该书，且该用户对于该书的一个成功预约视作完成，不再生效。否则取书失败，书籍不发生移动。

取书时，对于用户要取的这本书，如果预约处存在多本副本，只能取走整理操作时指定给该用户预留的书籍副本。

**查询流程**

若用户需要查询图书馆内某本书的历史移动轨迹信息，可前往自助查询机处查询：

输入“类别号-序列号-副本号”，查询某副本的历史移动轨迹。

可移动的状态包括：普通书架、热门书架、 借阅处、预约处、阅览室、用户。

**阅读流程**

若一位用户来到图书馆阅读某书籍，按照如下规则来进行处理：

1. 若欲阅读的书籍无余本在架，阅读失败；

2. 若该用户存在当日未阅读后归还的书籍，阅读失败；

3. 若欲阅读的书籍在架，则该用户会从书架上取走书籍，前往阅览室阅读，该书视为从普通书架/热门书架移动到阅览室，不能再被任何人借阅，用户阅读成功。

**归还流程**

若一位用户在当日已经成功阅读了某书籍，在当日闭馆前可以选择归还，则该用户会前往借还处，阅读归还立即成功，从此刻起，借还处持有该书，阅览室不再持有该书。

**注意：**用户可以选择不主动归还书籍，书籍始终留在阅览室直到整理流程中被归还到书架（见整理流程新增）

**热门书架**

初始时热门书架为空，此后，上次开馆时被阅读或借阅成功的ISBN号的所有副本视为热门书籍，其余书籍为非热门书籍。本次开馆整理后，热门图书所有副本都应移动或保留至热门书架，非热门图书移动或保留至普通书架。热门图书仍可被阅读、借阅、预约。例如：

- 2025-01-02这一天，A-0001-02号书籍被阅读了，下一次有输入的开馆时间为2025-01-05，则2025-01-05的开馆整理后，所有ISBN号为A-0001的副本都应被放到热门书架，其他没有被阅读或借阅过的ISBN号的所有副本都应被放到普通书架。

- 对于上次开馆时，同学们可以简单理解成程序上一次接收到开馆输入的日期。如果上次开馆后没有书籍被视为热门书籍，则本次开馆后热门书架为空。

**整理流程**

每次开馆和每次闭馆后，系统都有一次机会整理各处的图书，此时系统可以在不违反规则的情况下任意移动图书馆内的可在整理流程中移动的图书（整理的目的是为了满足请求，只要不违反限制，也可以不移动图书）。

为了保证图书馆的借阅成功率，对整理图书进行如下限制：

1. 在开馆对应的整理后（即在 OPEN 指令对应的整理后），借还处不应该有书，阅览室不应有书，预约处不应该有逾期的书。
2. 不可以为没有预定特定书籍的用户预留该书籍（即为该用户将该书籍送至预约处）。
3. 同学们可以自由考虑使用何种策略为预约预留书籍（没有特别限制，但建议以提高借阅成功率为目的），但是不允许无条件拒绝为预约预留书籍。
4. 在开馆对应的整理后（即在 OPEN 指令对应的整理后），热门书架不应有非热门书籍，普通书架不应有热门书籍。

## 二、规则描述

**图书借阅数量限制**

- A 类书：不可借阅，不可预约，可以阅读。
- B 类书：一人同一时刻仅能持有一个 B 类书的副本。
- C 类书：对于每一个ISBN号，一人同一时刻仅能持有一个具有该ISBN号的书籍副本。

**图书移动限制**

任何可以引起图书位置变化的操作，该书数量的变化符合实际（一次移动仅可以改变单一副本的位置，本次作业中任何时候图书总数不变）。

具体的，此次作业中，可以引起图书位置变化的操作如下：

- 用户借阅书架图书成功：普通书架/热门书架 -> 用户
- 用户取书：预约处 -> 用户
- 用户还书：用户 -> 借还处
- 用户阅读：普通书架/热门书架 -> 阅览室
- 用户归还：阅览室 -> 借还台
- 整理时的图书转运：借还处，普通书架，热门书架，预约处，阅览室这五个位置中从一个位置到另一个位置

# 输入输出
## 一、程序输入
程序输入由两部分组成：图书馆初始书目信息和用户请求动态信息。

输入第一行为一个正整数 n，代表图书馆中共有 n 种不同的图书。

接下来 n 行每行对应一种书的详细信息，格式为“类别号-序列号 副本数”，例如 "B-0001 10" 代表 B 类下序号为 0001 的书（即ISBN号为B-0001的书）馆藏 10 个副本。序列号为四位数字。输入保证不存在相同的 “类别号-序列号”，不同类别号下可以存在相同的序列号，每个ISBN号的书最多 10 个副本。副本号从1开始依递增顺序编号，例如 "B-0001 10" 代表十本书的编号为 B-0001-01, B-0001-02, …, B-0001-10。

接下来若干行每行对应一条动态信息，格式为"[YYYY-mm-dd] OPEN"和"[YYYY-mm-dd] CLOSE"之间的若干条"[YYYY-mm-dd] <学号> <操作> <类别号-序列号[-副本号]>"，代表在日期为 [YYYY-mm-dd] 的当天，用户 <学号> 对图书 <类别号-序列号[-副本号]> 进行 <操作>，除开馆指令和闭馆指令，设评测给定的指令条数为m。

请注意，初始数据点是给评测机的原始输入，并不等于同学们的程序实际接收到的输入。但我们保证同学们的程序接收到的输入，输入指令中操作的书籍编号，一定在图书馆中存在。

在评测数据中，所有请求指令都位于当日的开馆指令和闭馆指令之间，对于没有任何指令的日期，评测数据可能省略开闭馆指令。形式化的限制如下：

数据的所有指令时间严格不减（不可能出现时间倒流的情况）。
对于任意开馆指令 A ，存在且仅存在一条相同日期的闭馆指令 B ，且 B 位于 A 之后；对于任意闭馆指令 P ，存在且仅存在一条相同日期的开馆指令 Q ，且 Q 位于 P 之前。
对于任意请求指令 Q ，保证存在相同日期的开馆指令位于 Q 之前，保证存在相同日期的闭馆指令位于 Q 之后。
具体的 <操作> 种类：

queried：查询。
borrowed：借书。
ordered：预约书。
returned：还书。
picked：取书。
read：阅读。
restored：归还。
对于借还书动态信息，输入保证已按时间先后顺序排序。也即同一日期的全部信息，可理解为按照输入出现的顺序依次从早到晚发生。 在图书馆第1天开馆前，图书馆的所有书本均位于普通书架上。

1≤n≤100，1≤m≤200。 所有输入事件在 [2025-01-01] 至 [2025-12-31] 之间发生，保证日期合法。

输入信息展示如下：

场景	输入
图书馆开馆时输入	"[YYYY-mm-dd] OPEN"
图书馆闭馆时输入	"[YYYY-mm-dd] CLOSE"
用户查询书籍历史移动轨迹信息时输入	"[YYYY-mm-dd] <学号> queried <类别号-序列号-副本号>"
用户借书时输入	"[YYYY-mm-dd] <学号> borrowed <类别号-序列号>"
用户预约时输入	"[YYYY-mm-dd] <学号> ordered <类别号-序列号>"
用户还书时输入	"[YYYY-mm-dd] <学号> returned <类别号-序列号-副本号>"
用户取书时输入	"[YYYY-mm-dd] <学号> picked <类别号-序列号>"
用户阅读时输入	"[YYYY-mm-dd] <学号> read <类别号-序列号>"
用户归还时输入	"[YYYY-mm-dd] <学号> restored <类别号-序列号-副本号>"
借书、预约、阅读等指令格式为<类别号-序列号>，代表该ISBN号的书
查询、还书、归还等指令输入格式为<类别号-序列号-副本号>，代表该书号的某一本书
注意：评测详情中的stdin不是完整的输入，使用官方包的同学可以从stderr获取你的程序接收到的完整输入，不使用官方包自行处理输入输出的同学可以根据需要向stderr打印信息，或根据输出反推输入。

## 二、程序输出
当程序运行时发生表格中出现的场景时，要求输出相应信息。每条信息占一行。

开馆时：

场景	输出
用户查询书籍历史移动轨迹信息时输出	"[YYYY-mm-dd] <类别号-序列号-副本号> moving trace: <接下来的行数>"
"<序号> [YYYY-mm-dd] from <起点> to <终点>"(每次状态转移占据一行输出)
用户借书成功时输出	"[YYYY-mm-dd] [accept] <学号> borrowed <类别号-序列号-副本号>"
用户借书失败时输出	"[YYYY-mm-dd] [reject] <学号> borrowed <类别号-序列号>"
用户预约成功时输出	"[YYYY-mm-dd] [accept] <学号> ordered <类别号-序列号>"
用户预约失败时输出	"[YYYY-mm-dd] [reject] <学号> ordered <类别号-序列号>"
用户还书成功时输出	"[YYYY-mm-dd] [accept] <学号> returned <类别号-序列号-副本号>"
用户取书成功时输出	"[YYYY-mm-dd] [accept] <学号> picked <类别号-序列号-副本号>"
用户取书失败时输出	"[YYYY-mm-dd] [reject] <学号> picked <类别号-序列号>"
用户阅读成功时输出	"[YYYY-mm-dd] [accept] <学号> read <类别号-序列号-副本号>"
用户阅读失败时输出	"[YYYY-mm-dd] [reject] <学号> read <类别号-序列号>"
用户归还成功时输出	"[YYYY-mm-dd] [accept] <学号> restored <类别号-序列号-副本号>"
要求输出按照时间先后顺序排序。也即同一日期的全部信息，输出的顺序应与事件发生的先后顺序相同。

某日处理开馆后请求的输出，只应出现在当日开馆后，当日闭馆前。

借阅/阅读成功时输出的副本号可以满足其他条件下任意指定，保证后续对应的还书/归还指令的副本号与之相同

查询时：

接收到查询指令后，需要输出一个整数k作为该书籍的历史移动轨迹的条目数，接下来输出k行，每行一条书籍的历史移动轨迹。

本次作业中，我们规定书籍历史移动的所有可能经过的位置只能为如下六种：

bookshelf (简写作 bs) ：普通书架
hot bookshelf（简写作hbs）：热门书架
borrow and return office (简写作 bro) ：借还处
appointment office (简写作 ao) ：预约处
reading room（简写作rr）：阅览室
user ：用户
整理时：

接收到开馆指令OPEN和闭馆指令CLOSE以后，需要输出一个整数k作为准备进行的书籍移动次数，接下来输出k行，每行一条图书移动信息。

本次作业中，我们规定书籍移动的起点和终点只能为如下五种：

bookshelf (简写作 bs) ：普通书架
hot bookshelf (简写作 hbs)：热门书架
borrow and return office (简写作 bro) ：借还处
appointment office (简写作 ao) ：预约处
reading room (简写作 rr) ：阅览室